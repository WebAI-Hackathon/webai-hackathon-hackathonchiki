<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADnDI - Final Story</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="container">
      <h1 id="finalThemeTitle">The Adventure Concludes</h1>

      <div class="final-story">
        <div id="storyIllustration" class="illustration"></div>
        <div id="finalStoryText" class="story-text"></div>
      </div>

      <div class="final-characters">
        <h2>Your Party</h2>
        <div id="characterCards" class="cards-container"></div>
      </div>

      <button id="downloadStory" class="btn-primary">Download Story</button>
      <button id="newGame" class="btn-secondary">Start New Game</button>
    </div>

    <script src="js/app.js"></script>
    <script>
      let finalData = {};
      let characters = [];
      let characterImageUrls = [];
      const maxCharacters = 4;

      // Load any existing characters
      function loadCharacters() {
        const savedChars = localStorage.getItem("adndiCharacters");
        if (savedChars) {
          try {
            characters = JSON.parse(savedChars);
            // Enable next step button if we have characters
            document.getElementById("nextStep").disabled =
              characters.length === 0;
            renderCharacterCards();
          } catch (e) {
            console.error("Error loading characters:", e);
          }
        }
      }

      async function initFinalPage() {
        // Load final story data
        finalData = JSON.parse(localStorage.getItem("adndiFinalStory")) || {
          theme: "The Great Adventure",
          characters: [],
          story: "The story of your adventure...",
        };

        console.log(finalData.story);

        // Set theme title
        document.getElementById("finalThemeTitle").textContent =
          finalData.theme;

        // Render characters
        // tialize
        loadCharacters();
        renderCharacterCards();

        // Generate final illustration
        await generateFinalIllustration();

        // Display story
        document.getElementById("finalStoryText").innerHTML = await formatStoryText(
          finalData.story
        );
      }

      async function renderCharacterCards() {
        const container = document.getElementById("characterCards");
        container.innerHTML = "";

        if (characters.length === 0) {
          container.innerHTML =
            '<p class="empty-message">No characters created yet</p>';
          return;
        }

        // Show loading state
        container.innerHTML = '<div class="loading-spinner large"></div>';

        try {
          // Generate all image URLs in parallel
          log("Logging characters", characters);

          const imageRequests = characters.map((char) =>
            IMAGE_SERVICE.generateCharacterImage(
              char.description,
              char.type
            ).catch((error) => {
              console.error("Aboba Image generation failed:", error);
              return IMAGE_SERVICE.getPlaceholderImage(
                char.type,
                char.description
              ).url;
            })
          );

          // Wait for all requests to complete
          const imageUrls = await Promise.all(imageRequests);

          log("Logging the Image Requests", imageRequests);
          log("Logging the image urls", imageUrls);

          // Prefetch and validate images
          const loadedUrls = await IMAGE_SERVICE.prefetchImages(imageUrls);
          const validUrls = new Set(loadedUrls);

          console.log(imageUrls);

          // Render cards
          container.innerHTML = "";
          characters.forEach((char, index) => {
            const charImageUrl = imageUrls[index];
            const displayImage = validUrls.has(charImageUrl)
              ? { url: charImageUrl, isFallback: false }
              : IMAGE_SERVICE.getPlaceholderImage(char.type, char.description);

            const card = document.createElement("div");
            card.className = `character-card ${
              displayImage.isFallback ? "fallback-image" : ""
            }`;
            card.dataset.index = index;

            card.innerHTML = `
        <div class="card-image-container">
            <img src="${charImageUrl}" alt="${char.name}"
                 loading="lazy"
                 data-original-src="${charImageUrl}"
                 onerror="this.onerror=null;this.src='${
                   IMAGE_SERVICE.getPlaceholderImage(char.type).url
                 }'">
        </div>
        <div class="card-content">
            <h3>${escapeHTML(char.name)}</h3>
            <p><strong>Level:</strong> ${char.level}</p>
            <p><strong>Type:</strong> ${char.type}</p>
        </div>
      `;
            container.appendChild(card);
          });

          // Add event listeners for buttons
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const index = parseInt(
                e.target.closest(".character-card").dataset.index
              );
              deleteCharacter(index);
            });
          });

          // ... rest of your event listener code ...
        } catch (error) {
          console.error("Error rendering characters:", error);
          container.innerHTML =
            '<p class="error-message">Failed to load characters. Please refresh.</p>';
        }
      }

      async function generateFinalIllustration() {
        const prompt = `Fantasy art illustration depicting the climax of a D&D adventure with theme: ${
          finalData.theme
        }. 
                Include characters with these classes: ${finalData.characters
                  .map((c) => c.type)
                  .join(", ")}. 
                Dramatic, colorful, detailed.`;

        try {
          const response = await makeAPIRequest("image", {
            model: "hackathon/text2image",
            prompt: prompt + " /no_think",
            n: 1,
            size: "512x512",
          });

          const imageUrl = response.url;
          if (imageUrl) {
            document.getElementById("storyIllustration").innerHTML = `
        <img src="${imageUrl}" alt="Final Story Illustration">
      `;
          }
        } catch (error) {
          console.error("Error generating illustration:", error);
          // Use fallback image
          document.getElementById("storyIllustration").innerHTML = `
      <div class="placeholder-illustration">
        <p>Illustration could not be generated</p>
      </div>
    `;
        }
      }

      async function formatStoryText(text) {
        // Simple formatting
        let textRes = "";

        for (let paragraph of text) {
          textRes += paragraph
            .replace(/\n\n/g, "</p><p>")
            .replace(/\n/g, "<br>")
            .replace("**", "")
            .replace("*", "");
        }
        let testRes = await generateStorySummary(textRes)
        return testRes
      }

      async function generateStorySummary(text) {
        const prompt = `Make an interesting, thrilling and a vivid summary of the following story in less than 300 words:
      ${text} /no_think. Don't forget to make the story interesting and epic and not over the limit of 300 words`;

        const response = await makeAPIRequest("chat", {
          model: "hackathon/qwen3",
          messages: [
            {
              role: "system",
              content:
                "You are a creative fantasy writer who specializes in vivid story telling. /no_think",
            },
            {
              role: "user",
              content: prompt,
            },
          ],
          temperature: 0.7,
        });

        const story = response.choices[0].message.content.trim();

        // Basic validation
        if (!story || story.length < 50) {
          throw new Error("story generation failed - response too short");
        }

        return story;
      }

      document.getElementById("downloadStory").addEventListener("click", async () => {
        const htmlContent = generateHTML(
          finalData,
          document,
          await formatStoryText(finalData.story)
        );

        console.log(htmlContent);

        // Create download link
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${finalData.theme
          .replace(/[^a-z0-9]/gi, "_")
          .toLowerCase()}_adndi.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      document.getElementById("newGame").addEventListener("click", () => {
        localStorage.removeItem("adndiCharacters");
        localStorage.removeItem("adndiTheme");
        localStorage.removeItem("adndiFinalStory");
        window.location.href = "index.html";
      });

      // Initialize the page
      initFinalPage();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADnDI - Character Quiz</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <tool name="fill_out_quiz" description="Fill out the answers to the quiz">
      <prop name="name" type="string" description="Name of the character" required></prop>
      <prop name="gender" type="string" description="Female, male, or other" required></prop>
      <prop name="level" type="number" description="Level from 1 to 20 inclusive" required></prop>
      <prop name="archetype" type="string" description="Choose one from the existing list (Barbarian, Wizard, Rogue etc)" required></prop>
      <prop name="background" type="string" description="Choose a version of character-background" required></prop>
      <prop name="hair" type="string" description="Describe your character's hair" required></prop>
     <prop name="attitude" type="string" description="Choose one how the character reacts to conflicts" required></prop>
      <prop name="trait" type="string" description="Choose one: what is the defining trait of the character" required></prop>
      <prop name="companion" type="string" description="Choose oone: companion" required></prop>
      <prop name="struggle" type="string" description="Choose one: what is the character's inner struggle" required></prop>
    </tool>

    <tool name="generate" description="Generate the character"></tool>




    <!--
    <context name="quiz_status" id="quiz-context">
      Form status: Empty
      Required fields: name, gender, level, archetype, background, hair, attitude, trait, companion, struggle
      Filled fields: none
      Validation errors: none 
    </context>

  -->











    <div class="container">
      <h1>Character Quiz</h1>
      <form id="characterForm">
        <div class="form-group">
          <label for="characterName">Character Name:</label>
          <input type="text" id="characterName" required />
        </div>

        <div class="form-group">
          <label for="characterName">Character Gender</label>
          <div class="options-grid">
            <label><input type="radio" name="gender" value="male" />Male</label>
            <label
              ><input type="radio" name="gender" value="female" />Female</label
            >
            <label
              ><input type="radio" name="gender" value="other" />Other</label
            >
          </div>
        </div>

        <div class="form-group">
          <label for="characterLevel">Level:</label>
          <input
            type="number"
            id="characterLevel"
            min="1"
            max="20"
            value="1"
            required
          />
        </div>

        <!-- Core Fantasy Archetype -->
        <div class="form-group">
          <label>Core Fantasy Archetype:</label>
          <div class="options-grid">
            <label
              ><input
                type="radio"
                name="archetype"
                value="Barbarian"
                required
              />
              Barbarian</label
            >
            <label
              ><input type="radio" name="archetype" value="Bard" /> Bard</label
            >
            <label
              ><input type="radio" name="archetype" value="Cleric" />
              Cleric</label
            >
            <label
              ><input type="radio" name="archetype" value="Druid" />
              Druid</label
            >
            <label
              ><input type="radio" name="archetype" value="Fighter" />
              Fighter</label
            >
            <label
              ><input type="radio" name="archetype" value="Monk" /> Monk</label
            >
            <label
              ><input type="radio" name="archetype" value="Paladin" />
              Paladin</label
            >
            <label
              ><input type="radio" name="archetype" value="Ranger" />
              Ranger</label
            >
            <label
              ><input type="radio" name="archetype" value="Rogue" />
              Rogue</label
            >
            <label
              ><input type="radio" name="archetype" value="Sorcerer" />
              Sorcerer</label
            >
            <label
              ><input type="radio" name="archetype" value="Warlock" />
              Warlock</label
            >
            <label
              ><input type="radio" name="archetype" value="Wizard" />
              Wizard</label
            >
          </div>
        </div>

        <!-- Background/Origin -->
        <div class="form-group">
          <label for="background">Background/Origin:</label>
          <select id="background" required>
            <option value="">Select...</option>
            <option value="city">In a bustling city full of intrigue</option>
            <option value="village">
              A remote village surrounded by forest
            </option>
            <option value="ruins">Deep underground in ancient ruins</option>
            <option value="clouds">A floating city in the clouds</option>
            <option value="desert">A nomadic tribe crossing deserts</option>
            <option value="royalty">Among royalty in a majestic castle</option>
          </select>
        </div>

        <!-- Hair -->
        <div class="form-group">
          <label for="hair">Hair:</label>
          <input
            type="text"
            id="hair"
            placeholder="Describe your character's hair"
          />
        </div>

        <!-- Attitude toward conflict -->
        <div class="form-group">
          <label>Attitude toward conflict:</label>
          <div class="options-grid">
            <label
              ><input type="radio" name="conflict" value="peace" required />
              Always looking for peace</label
            >
            <label
              ><input type="radio" name="conflict" value="calm" /> Calm until
              provoked</label
            >
            <label
              ><input type="radio" name="conflict" value="fight" /> Loves a good
              fight</label
            >
            <label
              ><input type="radio" name="conflict" value="think" /> Thinks
              first, then acts</label
            >
            <label
              ><input type="radio" name="conflict" value="manipulate" />
              Manipulates others to avoid conflict</label
            >
            <label
              ><input type="radio" name="conflict" value="chaos" /> Welcomes
              chaos but never participates</label
            >
          </div>
        </div>

        <!-- Most defining trait -->
        <div class="form-group">
          <label>Most defining trait:</label>
          <div class="options-grid">
            <label
              ><input type="radio" name="trait" value="loyalty" required />
              Loyalty</label
            >
            <label
              ><input type="radio" name="trait" value="curiosity" />
              Curiosity</label
            >
            <label
              ><input type="radio" name="trait" value="ambition" />
              Ambition</label
            >
            <label
              ><input type="radio" name="trait" value="humor" /> Humor</label
            >
            <label
              ><input type="radio" name="trait" value="mystery" />
              Mystery</label
            >
            <label
              ><input type="radio" name="trait" value="honor" /> Honor</label
            >
          </div>
        </div>

        <!-- Companion -->
        <div class="form-group">
          <label>Companion:</label>
          <div class="options-grid">
            <label
              ><input type="radio" name="companion" value="owl" required /> A
              wise owl</label
            >
            <label
              ><input type="radio" name="companion" value="wolf" /> A fiery
              wolf</label
            >
            <label
              ><input type="radio" name="companion" value="fox" /> A sly
              fox</label
            >
            <label
              ><input type="radio" name="companion" value="dragon" /> A
              miniature dragon</label
            >
            <label
              ><input type="radio" name="companion" value="cat" /> A shadowy
              cat</label
            >
          </div>
        </div>

        <!-- Inner Struggle -->
        <div class="form-group">
          <label>Inner Struggle:</label>
          <div class="options-grid">
            <label
              ><input type="radio" name="struggle" value="curse" required /> A
              cursed part</label
            >
            <label
              ><input type="radio" name="struggle" value="love" /> Forbidden
              love</label
            >
            <label
              ><input type="radio" name="struggle" value="greed" /> Greed for
              power</label
            >
            <label
              ><input type="radio" name="struggle" value="demon" /> A literal
              demon within</label
            >
            <label
              ><input type="radio" name="struggle" value="doubt" />
              Self-doubt</label
            >
            <label
              ><input type="radio" name="struggle" value="peace" /> Nothing,
              they protect their peace</label
            >
          </div>
        </div>

        <button type="submit" class="btn-primary" id="generateButton">
          Generate your character
        </button>
      </form>
      <div id="errorDisplay" class="error-message" style="display: none"></div>
    </div>

    <script src="js/app.js"></script>
    <script>

      document
            .querySelector('tool[name="generate"]')
            .addEventListener("call", (e)=>{
                document.getElementById('generateButton').click();
                e.target.dispatchEvent(new CustomEvent("return", {
                    detail: {status:"Generation of the character started!"}
                }));
            });

    
      

document.querySelectorAll('tool[name]').forEach(tool => {
  const name = tool.getAttribute('name');
  tool.addEventListener('call', (e) => {
    const data = e.detail || {};
    const form = document.getElementById('characterForm');

    if (name === "fill_character_info") {
      if (data.characterName) form.querySelector("#characterName").value = data.characterName;
      if (data.gender) {
        const genderRadio = form.querySelector(input[name="gender"][value="${data.gender}"]);
        if (genderRadio) genderRadio.checked = true;
      }
      if (data.level) form.querySelector("#characterLevel").value = data.level;
    }

    if (name === "choose_character_traits") {
      const setRadio = (name, value) => {
        const el = form.querySelector(input[name="${name}"][value="${value}"]);
        if (el) el.checked = true;
      };
      if (data.archetype) setRadio("archetype", data.archetype);
      if (data.background) form.querySelector("#background").value = data.background;
      if (data.hair) form.querySelector("#hair").value = data.hair;
      if (data.conflict) setRadio("conflict", data.conflict);
      if (data.trait) setRadio("trait", data.trait);
      if (data.companion) setRadio("companion", data.companion);
      if (data.struggle) setRadio("struggle", data.struggle);
    }

    if (name === "submit_character_form") {
      form.requestSubmit();
    }
  });
});


      document
        .getElementById("characterForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Safely get elements with null checks
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const errorDisplay =
            document.getElementById("errorDisplay") || createErrorDisplay();

          try {
            // Show loading state
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.textContent = "Generating...";
            }

            if (errorDisplay) {
              errorDisplay.style.display = "none";
              errorDisplay.textContent = "";
            }

            // Collect and validate form data
            const formData = getFormData();
            validateFormData(formData);

            // Generate character
            const character = await generateCharacter(formData);

            // Save and redirect
            saveCharacterToLocalStorage(character);
            window.location.href = "character-creation.html";
          } catch (error) {
            console.error("Character generation failed:", error);
            showError(errorDisplay, error.message);
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = "Generate your character";
            }
          }
        });

      // Helper function to create error display if it doesn't exist
      function createErrorDisplay() {
        const errorDiv = document.createElement("div");
        errorDiv.id = "errorDisplay";
        errorDiv.className = "error-message";
        document.querySelector(".container").appendChild(errorDiv);
        return errorDiv;
      }

      // Improved error display function
      function showError(element, message) {
        if (!element) return;

        element.innerHTML = `
        <div class="error-content">
            <p>${escapeHTML(message)}</p>
            <button onclick="this.parentElement.style.display='none'">Dismiss</button>
        </div>
    `;
        element.style.display = "block";
      }

      function debugStorage() {
        // checking the inhalt of the storage
        console.log(localStorage.getItem("adndiCharacters"));

        // checking how many characters are there in array
        const stored = localStorage.getItem("adndiCharacters");
        const characters = stored ? JSON.parse(stored) : [];
        console.log("Character count:", characters.length);

        // the actual bit size
        const size = new Blob([JSON.stringify(characters)]).size;
        console.log("Size in bytes:", size);
      }

      // Form data collection with validation
      function getFormData() {
        debugStorage();

        const form = document.getElementById("characterForm");
        return {
          name: form.querySelector("#characterName").value.trim(),
          gender: form.querySelector('input[name="gender"]:checked').value,
          level: form.querySelector("#characterLevel").value,
          archetype: form.querySelector('input[name="archetype"]:checked')
            ?.value,
          background: form.querySelector("#background").value,
          hair: form.querySelector("#hair").value.trim(),
          conflict: form.querySelector('input[name="conflict"]:checked')?.value,
          trait: form.querySelector('input[name="trait"]:checked')?.value,
          companion: form.querySelector('input[name="companion"]:checked')
            ?.value,
          struggle: form.querySelector('input[name="struggle"]:checked')?.value,
        };
      }

      function validateFormData(formData) {
        const errors = [];

        if (!formData.name) errors.push("Character name is required");
        if (!formData.gender) errors.push("Please select a character gender");
        if (!formData.archetype)
          errors.push("Please select a character archetype");
        if (!formData.background) errors.push("Please select a background");
        if (
          isNaN(formData.level) ||
          formData.level < 1 ||
          formData.level > 20
        ) {
          errors.push("Level must be between 1 and 20");
        }

        if (errors.length > 0) {
          throw new Error(errors.join("\n"));
        }
      }
      function enhancePrompt(description, archetype) {
        const styleGuide = {
          barbarian:
            "dynamic pose, battle-scarred, wild hair, dramatic lighting",
          wizard:
            "intricate robes, glowing magical effects, scholarly demeanor",
          rogue: "shadowy, agile pose, leather armor, mysterious atmosphere",
          cleric: "holy symbols, radiant light, pious expression",
          druid: "nature elements, animal companions, wild appearance",
          fighter: "armor, weapons, battle-ready stance",
          paladin: "knightly armor, holy aura, determined expression",
          ranger: "camouflage, bow or dual weapons, animal companion nearby",
          sorcerer: "innate magic, chaotic energy, dramatic pose",
          warlock: "pact marks, dark energy, mysterious aura",
          bard: "musical instrument, flamboyant clothes, charismatic smile",
          monk: "simple robes, focused expression, martial arts stance",
        };

        return `D&D ${archetype} character portrait: ${description.substring(
          0,
          900
        )}. 
      ${styleGuide[archetype.toLowerCase()] || ""}
      Fantasy art, digital painting, highly detailed, vibrant colors, 
      character centered, artstation trending`;
      }

      function saveCharacterToLocalStorage(character) {
        const maxCharacters = 4;
        let characters = [];

        try {
          characters = JSON.parse(
            localStorage.getItem("adndiCharacters") || "[]"
          );

          // Enforce max characters
          if (characters.length >= maxCharacters) {
            characters = characters.slice(-maxCharacters + 1);
          }

          characters.push(character);

          const json = JSON.stringify(characters);
          const size = new Blob([json]).size;

          console.log(`üíæ Saving ${size} bytes to localStorage...`);

          // Rough quota warning (5MB = 5 * 1024 * 1024)
          if (size > 4500000) {
            throw new Error(
              "Character data too large to store. Please remove some old characters."
            );
          }

          localStorage.setItem("adndiCharacters", json);
        } catch (e) {
          console.error("‚ùå Error saving character to localStorage:", e);
          alert(
            "‚ö†Ô∏è Unable to save character. Local storage may be full or corrupted."
          );
        }
      }

      function showError(element, message) {
        element.innerHTML = `<div class="error-content"><p>${escapeHTML(
          message
        )}</p><button onclick="this.parentElement.style.display='none'">Dismiss</button></div>`;
        element.style.display = "block";
      }

      function escapeHTML(str) {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }
    </script>
  </body>
</html>

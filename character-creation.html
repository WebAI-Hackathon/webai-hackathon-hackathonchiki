<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADnDI - Character Creation</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Let's create your characters!</h1>
      <div id="characterCards" class="cards-container"></div>

      <div class="actions">
        <button id="createCharacter" class="btn-primary">
          Create new character
        </button>
        <button id="nextStep" class="btn-secondary" disabled>Next step</button>
      </div>
    </div>

    <script src="js/app.js"></script>
    <script>
      let characters = [];
      let characterImageUrls = [];
      const maxCharacters = 4;

      document
        .getElementById("createCharacter")
        .addEventListener("click", () => {
          if (characters.length < maxCharacters) {
            window.location.href = "character-quiz.html";
          } else {
            alert(`Maximum of ${maxCharacters} characters allowed`);
          }
        });

      document.getElementById("nextStep").addEventListener("click", () => {
        if (characters.length > 0) {
          localStorage.setItem("adndiCharacters", JSON.stringify(characters));
          window.location.href = "game-theme.html";
        }
      });

      // Helper function to truncate description
      function truncateDescription(text, maxLength = 100) {
        if (text.length <= maxLength) return escapeHTML(text);
        return escapeHTML(text.substring(0, maxLength)) + "...";
      }

      // Load any existing characters
      function loadCharacters() {
        const savedChars = localStorage.getItem("adndiCharacters");
        if (savedChars) {
          try {
            characters = JSON.parse(savedChars);
            // Enable next step button if we have characters
            document.getElementById("nextStep").disabled =
              characters.length === 0;
            renderCharacterCards();
          } catch (e) {
            console.error("Error loading characters:", e);
            localStorage.removeItem("adndiCharacters");
          }
        }
      }

      async function renderCharacterCards() {
        const container = document.getElementById("characterCards");
        container.innerHTML = "";

        if (characters.length === 0) {
          container.innerHTML =
            '<p class="empty-message">No characters created yet</p>';
          return;
        }

        // Show loading state
        container.innerHTML = '<div class="loading-spinner large"></div>';

        try {
          // Generate all image URLs in parallel
          const imageRequests = characters.map((char) =>
            generateCharacterImageUrl(char.image).catch((error) => {
              console.error("Image generation failed:", error);
              return IMAGE_SERVICE.getPlaceholderImage(
                char.type,
                char.description
              ).url;
            })
          );

          // Wait for all requests to complete
          const imageUrls = await Promise.all(imageRequests);

          // Prefetch and validate images
          const loadedUrls = await IMAGE_SERVICE.prefetchImages(imageUrls);
          const validUrls = new Set(loadedUrls);

          // Render cards
          container.innerHTML = "";
          characters.forEach((char, index) => {
            const charImageUrl = imageUrls[index];
            const displayImage = validUrls.has(charImageUrl)
              ? { url: charImageUrl, isFallback: false }
              : IMAGE_SERVICE.getPlaceholderImage(char.type, char.description);

            const card = document.createElement("div");
            card.className = `character-card ${
              displayImage.isFallback ? "fallback-image" : ""
            }`;
            card.dataset.index = index;

            card.innerHTML = `
        <div class="card-actions">
            <button class="card-btn delete-btn" title="Delete character">üóëÔ∏è</button>
        </div>
        <div class="card-image-container">
            <img src="${charImageUrl}" alt="${char.name}"
                 loading="lazy"
                 data-original-src="${charImageUrl}"
                 onerror="this.onerror=null;this.src='${
                   IMAGE_SERVICE.getPlaceholderImage(char.type).url
                 }'">
        </div>
        <div class="card-content">
            <h3>${escapeHTML(char.name)}</h3>
            <p><strong>Level:</strong> ${char.level}</p>
            <p><strong>Type:</strong> ${char.type}</p>
            <div class="description-preview">${truncateDescription(
              char.description
            )}</div>
        </div>
      `;
            container.appendChild(card);
          });

          // Add event listeners for buttons
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const index = parseInt(
                e.target.closest(".character-card").dataset.index
              );
              deleteCharacter(index);
            });
          });
          
          // ... rest of your event listener code ...
        } catch (error) {
          console.error("Error rendering characters:", error);
          container.innerHTML =
            '<p class="error-message">Failed to load characters. Please refresh.</p>';
        }
      }

      function deleteCharacter(index) {
        if (confirm(`Delete ${characters[index].name}?`)) {
          characters.splice(index, 1);
          localStorage.setItem("adndiCharacters", JSON.stringify(characters));
          document.getElementById("nextStep").disabled =
            characters.length === 0;
          renderCharacterCards();
        }
      }

      // ... existing code ...

      // Add prompt enhancement function
      /*
      function enhancePrompt(description, archetype) {
        const styleGuide = {
          barbarian: "dynamic pose, battle-scarred, wild hair, dramatic lighting",
          wizard: "intricate robes, glowing magical effects, scholarly demeanor",
          rogue: "shadowy, agile pose, leather armor, mysterious atmosphere",
          // Add more archetypes as needed
        };

        return `D&D ${archetype} character portrait: ${description.substring(0, 900)}.
          ${styleGuide[archetype.toLowerCase()] || ''}
          Fantasy art, digital painting, highly detailed, vibrant colors,
          character centered, artstation trending`;
      }*/

      // ... rest of file ...
      function showLoadingState(index, isLoading) {
        const card = document.querySelector(
          `.character-card[data-index="${index}"]`
        );
        if (!card) return;

        const imgContainer = card.querySelector(".card-image-container");
        if (isLoading) {
          imgContainer.innerHTML = '<div class="loading-spinner"></div>';
        } else {
          const char = characters[index];
          imgContainer.innerHTML = `
                  <img src="${char.image}" alt="${char.name}">
              `;
        }
      }
      /*
            function getClassPlaceholder(archetype) {
              // SVG placeholder with class colors
              const colors = {
                barbarian: "#772422",
                bard: "#5a3d7a",
                cleric: "#e0a040",
                druid: "#5c7c3a",
                fighter: "#8a8a8a",
                monk: "#d4b16a",
                paladin: "#c0c0e0",
                ranger: "#6b8c42",
                rogue: "#735c3a",
                sorcerer: "#8a2be2",
                warlock: "#6a287e",
                wizard: "#2a4b8d",
              };

              const color = colors[archetype.toLowerCase()] || "#4a2c82";

              return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"  height="512" viewBox="0 0 512 512">
              <rect  height="512" fill="${color}" />
          </svg>`;
            }

            function escapeHTML(str) {
              return str.replace(
                /[&<>'"]/g,
                (tag) =>
                  ({
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    "'": "&#39;",
                    '"': "&quot;",
                  }[tag])
              );
            }
      */
      // tialize
      loadCharacters();
    </script>
  </body>
</html>
